<div class="dashboard">
  <!-- Header -->
  <div class="dash-header">
    <h2 class="dash-title">
      <i class="bi bi-bar-chart-fill"></i>
      Tableau de bord Recruteur
    </h2>
    <div class="dash-actions">
      <select class="form-select year-select" [(ngModel)]="year" (change)="reloadMonthly()">
        <option *ngFor="let y of [year, year-1, year-2]" [value]="y">{{ y }}</option>
      </select>
      <button class="btn btn-light btn-refresh" (click)="loadAll()">
        <i class="bi bi-arrow-repeat"></i>
        Actualiser
      </button>
    </div>
  </div>

  <!-- KPI widgets -->
  <div class="widgets" *ngIf="overview">
    <div class="widget">
      <div class="kpi-icon bg-primary-subtle text-primary"><i class="bi bi-briefcase"></i></div>
      <div class="kpi">
        <span class="title">Offres</span>
        <span class="val">{{ overview.totalOffers }}</span>
      </div>
    </div>
    <div class="widget">
      <div class="kpi-icon bg-success-subtle text-success"><i class="bi bi-lightning-charge"></i></div>
      <div class="kpi">
        <span class="title">Actives</span>
        <span class="val">{{ overview.activeOffers }}</span>
      </div>
    </div>
    <div class="widget">
      <div class="kpi-icon bg-secondary-subtle text-secondary"><i class="bi bi-hourglass-bottom"></i></div>
      <div class="kpi">
        <span class="title">Expirées</span>
        <span class="val">{{ overview.expiredOffers }}</span>
      </div>
    </div>
    <div class="widget">
      <div class="kpi-icon bg-info-subtle text-info"><i class="bi bi-people"></i></div>
      <div class="kpi">
        <span class="title">Candidatures</span>
        <span class="val">{{ overview.totalCandidatures }}</span>
      </div>
    </div>
    <div class="widget">
      <div class="kpi-icon bg-warning-subtle text-warning"><i class="bi bi-hourglass-split"></i></div>
      <div class="kpi">
        <span class="title">En attente</span>
        <span class="val">{{ overview.pendingCandidatures }}</span>
      </div>
    </div>
    <div class="widget">
      <div class="kpi-icon bg-success-subtle text-success"><i class="bi bi-check2-circle"></i></div>
      <div class="kpi">
        <span class="title">Acceptées</span>
        <span class="val">{{ overview.acceptedCandidatures }}</span>
      </div>
    </div>
    <div class="widget">
      <div class="kpi-icon bg-danger-subtle text-danger"><i class="bi bi-x-circle"></i></div>
      <div class="kpi">
        <span class="title">Refusées</span>
        <span class="val">{{ overview.rejectedCandidatures }}</span>
      </div>
    </div>
    <div class="widget">
      <div class="kpi-icon bg-primary-subtle text-primary"><i class="bi bi-person-lines-fill"></i></div>
      <div class="kpi">
        <span class="title">Candidats / Offre</span>
        <span class="val">{{ overview.avgCandidatesPerOffer | number:'1.1-1' }}</span>
      </div>
    </div>
    <div class="widget">
      <div class="kpi-icon bg-dark-subtle text-dark"><i class="bi bi-stopwatch"></i></div>
      <div class="kpi">
        <span class="title">Jours 1er cand.</span>
        <span class="val">{{ overview.avgDaysToFirstCandidate | number:'1.0-0' }}</span>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="grid">
    <div class="card chart-card">
      <div class="card-head">
        <h4>Offres par statut</h4>
      </div>
      <div class="chart-box">
        <c-chart type="doughnut" [data]="statusData" [options]="donutOptions"></c-chart>
      </div>
    </div>

    <div class="card chart-card">
      <div class="card-head">
        <h4>Candidatures par mois ({{ year }})</h4>
      </div>
      <div class="chart-box">
        <c-chart type="line" [data]="monthlyData" [options]="lineOptions"></c-chart>
      </div>
    </div>

    <div class="card chart-card">
      <div class="card-head">
        <h4>Candidatures par source (90j)</h4>
      </div>
      <div class="chart-box">
        <c-chart type="doughnut" [data]="sourceData" [options]="donutOptions"></c-chart>
      </div>
    </div>

    <div class="card chart-card">
      <div class="card-head">
        <h4>Offres par type</h4>
      </div>
      <div class="chart-box">
        <c-chart type="bar" [data]="typeData" [options]="barOptions"></c-chart>
      </div>
    </div>

    <!-- Top offres -->
    <div class="card top-card">
      <div class="card-head">
        <h4>Top offres</h4>
      </div>
      <div class="table-wrap">
        <table class="table table-modern">
          <thead>
            <tr><th>#</th><th>Titre</th><th>Publiée</th><th>Statut</th><th class="text-end">Candidats</th></tr>
          </thead>
          <tbody>
            <tr *ngFor="let o of topOffers; let i = index">
              <td>{{ i+1 }}</td>
              <td class="truncate">{{ o.titre }}</td>
              <td>{{ o.datePublication | date:'dd/MM/yyyy' }}</td>
              <td><span class="badge rounded-pill bg-light text-body border">{{ o.statut }}</span></td>
              <td class="text-end fw-bold">{{ o.candidates }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Vue d'ensemble par site / type -->
<div class="container mt-4">
  <h3 class="section-title">Vue d'ensemble des candidatures par type d'offre</h3>

  <div class="row">
    <div class="col-md-6" *ngFor="let site of objectKeys(statsPersonnelles)">
      <div class="card soft-card mb-4">
        <div class="card-header bg-success text-white d-flex align-items-center">
          <i class="bi bi-globe2 me-2"></i>
          <h5 class="mb-0">{{ site }}</h5>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between align-items-center"
                *ngFor="let type of objectKeys(statsPersonnelles[site])">
              <span><i [class]="getTypeIcon(type)"></i> {{ type }}</span>
              <span class="badge bg-success-subtle text-success rounded-pill px-3 py-2">
                {{ statsPersonnelles[site][type] }}
              </span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
