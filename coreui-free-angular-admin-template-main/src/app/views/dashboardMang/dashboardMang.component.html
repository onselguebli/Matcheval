<div class="dashboard">
  <div class="dash-header">
    <h2 class="dash-title"><i class="bi bi-graph-up-arrow"></i> Tableau de bord Manager</h2>
    <div class="dash-actions">
      <select class="form-select year-select" [(ngModel)]="year" (change)="reloadMonthly()">
        <option *ngFor="let y of [year, year-1, year-2]" [value]="y">{{ y }}</option>
      </select>
      <select class="form-select year-select" [(ngModel)]="rangeDays" (change)="load()">
        <option [value]="30">30 jours</option>
        <option [value]="60">60 jours</option>
        <option [value]="90">90 jours</option>
      </select>
      <button class="btn btn-light" (click)="load()"><i class="bi bi-arrow-repeat me-1"></i>Actualiser</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="widgets" *ngIf="overview">
    <div class="widget"><div class="kpi-icon"><i class="bi bi-people"></i></div><div class="kpi"><span class="title">Recruteurs</span><span class="val">{{ overview.totalRecruiters }}</span></div></div>
    <div class="widget"><div class="kpi-icon"><i class="bi bi-briefcase"></i></div><div class="kpi"><span class="title">Offres</span><span class="val">{{ overview.totalOffers }}</span></div></div>
    <div class="widget"><div class="kpi-icon"><i class="bi bi-lightning-charge"></i></div><div class="kpi"><span class="title">Actives</span><span class="val">{{ overview.activeOffers }}</span></div></div>
    <div class="widget"><div class="kpi-icon"><i class="bi bi-hourglass-bottom"></i></div><div class="kpi"><span class="title">Expirées</span><span class="val">{{ overview.expiredOffers }}</span></div></div>
    <div class="widget"><div class="kpi-icon"><i class="bi bi-person-lines-fill"></i></div><div class="kpi"><span class="title">Candidatures</span><span class="val">{{ overview.totalCandidatures }}</span></div></div>
    <div class="widget"><div class="kpi-icon"><i class="bi bi-hourglass-split"></i></div><div class="kpi"><span class="title">En attente</span><span class="val">{{ overview.pending }}</span></div></div>
    <div class="widget"><div class="kpi-icon"><i class="bi bi-check2-circle"></i></div><div class="kpi"><span class="title">Acceptées</span><span class="val">{{ overview.accepted }}</span></div></div>
    <div class="widget"><div class="kpi-icon"><i class="bi bi-x-circle"></i></div><div class="kpi"><span class="title">Refusées</span><span class="val">{{ overview.rejected }}</span></div></div>
    <div class="widget"><div class="kpi-icon"><i class="bi bi-clipboard-data"></i></div><div class="kpi"><span class="title">Cand./offre</span><span class="val">{{ overview.avgCandidatesPerOffer | number:'1.1-1' }}</span></div></div>
    <div class="widget"><div class="kpi-icon"><i class="bi bi-stopwatch"></i></div><div class="kpi"><span class="title">Jours 1er cand.</span><span class="val">{{ overview.avgDaysToFirstCandidate | number:'1.0-0' }}</span></div></div>
    <div class="widget"><div class="kpi-icon"><i class="bi bi-bookmark-check"></i></div><div class="kpi"><span class="title">Sélections (30j)</span><span class="val">{{ overview.checkedMatchesLast30 }}</span></div></div>
  </div>

  <!-- Charts -->
  <div class="grid">
    <div class="card chart-card">
      <div class="card-head"><h4>Candidatures par source ({{rangeDays}}j)</h4></div>
      <div class="chart-box"><c-chart type="doughnut" [data]="donutSources" [options]="donutOpt"></c-chart></div>
    </div>

    <div class="card chart-card">
      <div class="card-head"><h4>Candidatures par mois ({{year}})</h4></div>
      <div class="chart-box"><c-chart type="line" [data]="lineMonthly" [options]="lineOpt"></c-chart></div>
    </div>

    <div class="card chart-card">
      <div class="card-head"><h4>Candidatures par recruteur ({{rangeDays}}j)</h4></div>
      <div class="chart-box"><c-chart type="bar" [data]="barByRecruiter" [options]="barOpt"></c-chart></div>
    </div>

    <div class="card chart-card">
      <div class="card-head"><h4>Pipeline par recruteur ({{rangeDays}}j)</h4></div>
      <div class="chart-box"><c-chart type="bar" [data]="barPipeline" [options]="barOpt"></c-chart></div>
    </div>

    <!-- Top offres -->
    <div class="card top-card">
      <div class="card-head"><h4>Top offres</h4></div>
      <div class="table-wrap">
        <table class="table table-modern">
          <thead><tr><th>#</th><th>Titre</th><th>Publiée</th><th>Statut</th><th class="text-end">Candidats</th></tr></thead>
          <tbody>
            <tr *ngFor="let o of topOffers; let i = index; trackBy: trackByIdx">
              <td>{{ i+1 }}</td>
              <td class="truncate">{{ o.titre }}</td>
              <td>{{ o.datePublication | date:'dd/MM/yyyy' }}</td>
              <td><span class="badge rounded-pill bg-light text-body border">{{ o.statut }}</span></td>
              <td class="text-end fw-bold">{{ o.candidates }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Prochains meetings -->
    <div class="card top-card">
      <div class="card-head"><h4>Réunions à venir (14j)</h4></div>
      <div class="table-wrap">
        <table class="table table-modern">
          <thead><tr><th>Titre</th><th>Salle</th><th>Date</th><th>Durée</th></tr></thead>
          <tbody>
            <tr *ngFor="let m of meetings; trackBy: trackByIdx">
              <td class="truncate">{{ m.title }}</td>
              <td>{{ m.roomName }}</td>
              <td>{{ m.startAt | date:'dd/MM/yyyy HH:mm' }}</td>
              <td>{{ m.durationMin }} min</td>
            </tr>
            <tr *ngIf="!meetings?.length"><td colspan="4" class="text-center text-muted">Aucune réunion</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
