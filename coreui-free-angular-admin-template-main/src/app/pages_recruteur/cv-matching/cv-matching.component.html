<div class="cv-matching-container">
  <div class="header">
    <h2>ğŸ” Matching CVs avec Offres d'Emploi</h2>
    <p>Analysez la correspondance entre des CVs et vos offres d'emploi</p>
  </div>

  <!-- Section de sÃ©lection -->
  <div class="selection-section">
    <div class="form-group">
      <label for="offreSelect">SÃ©lectionner une offre d'emploi:</label>

      <!-- Indicateur de chargement -->
      <div *ngIf="loadingOffres" class="loading-indicator">
        <div class="spinner"></div>
        <span>Chargement de vos offres...</span>
      </div>

      <select
        id="offreSelect"
        class="form-control"
        (change)="onOffreSelected($event)"
        [disabled]="loadingOffres || offres.length === 0">
        <option value="">-- Choisir une offre --</option>
        <option *ngFor="let offre of offres" [value]="offre.id">
          {{ offre.titre }} - {{ offre.localisation}} ({{ offre.datePublication | date:'dd/MM/yyyy' }})
        </option>
      </select>

      <!-- Message si aucune offre -->
      <div *ngIf="!loadingOffres && offres.length === 0" class="no-offres">
        <p>ğŸ“ Aucune offre d'emploi crÃ©Ã©e.</p>
        <a routerLink="/creer-offre" class="btn-create-offre">â• CrÃ©er une offre</a>
      </div>
    </div>

    <!-- Offre sÃ©lectionnÃ©e -->
    <div class="selected-offre" *ngIf="selectedOffre">
      <div class="offre-header">
        <h4>ğŸ¯ Offre sÃ©lectionnÃ©e</h4>
        <span class="offre-id">#{{ selectedOffre.id }}</span>
      </div>
      <div class="offre-details">
        <h5>{{ selectedOffre.titre }}</h5>
        <p class="location">ğŸ“ {{ selectedOffre.localisation }}</p>
        <p class="date">ğŸ“… PubliÃ©e le: {{ selectedOffre.datePublication | date:'dd/MM/yyyy' }}</p>
        <div class="description">
          <p>{{ selectedOffre.description }}</p>
        </div>
      </div>
    </div>

    <!-- Section 1: Upload de nouveaux CVs -->
    <div class="section-card">
      <div class="section-header">
        <h3>ğŸ“¤ Nouveaux CVs Ã  analyser</h3>
        <span class="section-badge">Upload</span>
      </div>

      <div class="file-upload-section">
        <label for="cvFiles">ğŸ“‚ SÃ©lectionner des CVs (PDF):</label>
        <div class="file-input-container">
          <input
            id="cvFiles"
            type="file"
            multiple
            accept=".pdf"
            (change)="onFileSelected($event)"
            class="file-input">
          <label for="cvFiles" class="file-input-label">ğŸ“ Choisir des fichiers</label>
        </div>

        <!-- Fichiers sÃ©lectionnÃ©s -->
        <div class="selected-files" *ngIf="selectedFiles.length > 0">
          <h5>ğŸ“‹ Fichiers sÃ©lectionnÃ©s ({{ selectedFiles.length }})</h5>
          <div class="files-list">
            <div *ngFor="let file of selectedFiles" class="file-item">
              <span class="file-icon">ğŸ“„</span>
              <span class="file-name">{{ file.name }}</span>
              <span class="file-size">({{ file.size | number }} bytes)</span>
            </div>
          </div>
        </div>

        <!-- Actions pour les nouveaux CVs -->
        <div class="actions upload-actions">
          <button
            class="btn btn-primary"
            (click)="uploadAndMatch()
            "
            [disabled]="!selectedOffre || selectedFiles.length === 0 || uploading">
            <span *ngIf="uploading" class="btn-spinner"></span>
            {{ uploading ? 'â³ Analyse en cours...' : 'ğŸš€ Analyser les CVs uploadÃ©s' }}
          </button>

          <button class="btn btn-outline" (click)="clearUploadedFiles()">
            ğŸ—‘ï¸ Effacer la sÃ©lection
          </button>
        </div>
      </div>
    </div>

    <!-- Section 2: CVs dÃ©jÃ  liÃ©s Ã  l'offre -->
    <div class="section-card" *ngIf="selectedOffre">
      <div class="section-header">
        <h3>ğŸ“ CVs dÃ©jÃ  liÃ©s Ã  cette offre</h3>
        <span class="section-badge">Base de donnÃ©es</span>
      </div>

      <!-- Indicateur de chargement -->
      <div *ngIf="loadingLinkedCvs" class="loading-indicator">
        <div class="spinner"></div>
        <span>Chargement des CVs liÃ©s...</span>
      </div>

      <!-- Liste des CVs liÃ©s -->
      <div *ngIf="!loadingLinkedCvs && linkedCvs.length > 0" class="linked-cvs-list">
        <div class="linked-cvs-header">
          <span>{{ linkedCvs.length }} CV(s) trouvÃ©(s)</span>
          <button
            class="btn btn-secondary"
            (click)="analyzeAllLinkedCvs()"
            [disabled]="loading || linkedCvs.length === 0">
            <span *ngIf="loading" class="btn-spinner"></span>
            ğŸ” Analyser tous
          </button>
        </div>

        <div class="linked-cvs-grid">
          <div *ngFor="let cv of linkedCvs" class="linked-cv-item">
            <div class="cv-info">
              <span class="cv-icon">ğŸ“„</span>
              <div class="cv-details">
                <h5>{{ cv.candidatPrenom }} {{ cv.candidatNom }}</h5>
                <p class="cv-email">{{ cv.candidatEmail }}</p>
                <p class="cv-date">Soumis le: {{ cv.dateSoumission | date:'dd/MM/yyyy' }}</p>
                <p class="cv-filename" *ngIf="cv.cvOriginalFilename">Fichier: {{ cv.cvOriginalFilename }}</p>
              </div>
            </div>
            <div class="cv-actions">
              <button class="btn btn-small" (click)="analyzeLinkedCv(cv.id)" [disabled]="loading">ğŸ” Analyser</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Message si aucun CV liÃ© -->
      <div *ngIf="!loadingLinkedCvs && linkedCvs.length === 0" class="no-linked-cvs">
        <p>ğŸ“ Aucun CV n'est actuellement liÃ© Ã  cette offre.</p>
      </div>

      <!-- Actions pour les CVs existants -->
      <div class="actions existing-actions">
        <button
          class="btn btn-secondary"
          (click)="matchExistingCvs()"
          [disabled]="!selectedOffre || loading">
          <span *ngIf="loading" class="btn-spinner"></span>
          {{ loading ? 'â³ Chargement...' : 'ğŸ“Š Analyser tous les CVs existants' }}
        </button>
        <!-- (le vieux bouton â€œAjouter la sÃ©lectionâ€ a Ã©tÃ© retirÃ© dâ€™ici) -->
      </div>
    </div>
  </div>

  <!-- Messages d'Ã©tat -->
  <div class="messages">
    <div *ngIf="error" class="message error">
      <span class="message-icon">âŒ</span>
      <span class="message-text">{{ error }}</span>
      <button class="message-close" (click)="error = null">Ã—</button>
    </div>

    <div *ngIf="success" class="message success">
      <span class="message-icon">âœ…</span>
      <span class="message-text">{{ success }}</span>
      <button class="message-close" (click)="success = null">Ã—</button>
    </div>

    <div *ngIf="loading" class="message info">
      <span class="message-icon">â³</span>
      <span class="message-text">Analyse des CVs en cours...</span>
    </div>
  </div>

  <!-- RÃ©sultats -->
  <div class="results-section" *ngIf="matchingResults.length > 0">
    <div class="results-header">
      <h3>ğŸ“Š RÃ©sultats du Matching</h3>

      <div class="results-actions">
        <!-- BARRE GLOBALE: visible si au moins 1 case cochÃ©e -->
        <div class="bulk-select" *ngIf="(selectedMap | keyvalue).length > 0">
          <span class="muted">{{ (selectedMap | keyvalue).length }} sÃ©lectionnÃ©(s)</span>
          <button class="btn btn-sm btn-success" (click)="checkSelected()" [disabled]="loading">
            âœ”ï¸ Ajouter la sÃ©lection Ã  la liste
          </button>
          <a class="btn btn-sm btn-outline" routerLink="/checked-list">ğŸ“„ Voir la liste des CV cochÃ©s</a>
        </div>

        <span class="results-count">{{ matchingResults.length }} rÃ©sultat(s)</span>
        <button class="btn btn-download" (click)="downloadResults()">ğŸ“¥ Exporter CSV</button>
        <button class="btn btn-outline" (click)="clearResults()">ğŸ—‘ï¸ Effacer les rÃ©sultats</button>
      </div>
    </div>

    <div class="results-grid">
      <div *ngFor="let result of matchingResults; let i = index" class="result-card">

        <!-- En-tÃªte avec nom et score -->
        <div class="card-header">
          <div class="card-rank">#{{ i + 1 }}</div>
          <h4>{{ result.filename || (result.candidatPrenom + ' ' + result.candidatNom) || 'CV sans nom' }}</h4>

          <span *ngIf="result.score_overall !== undefined && result.score_overall !== null"
                class="score-badge"
                [class]="getScoreClass(result.score_overall)">
            {{ result.score_overall * 100 | number:'1.0-0' }}%
          </span>
          <span *ngIf="result.score_overall === undefined || result.score_overall === null" class="score-badge score-poor">
            N/A
          </span>

          <span class="result-source" *ngIf="result.candidatureId">ğŸ“ Base de donnÃ©es</span>
          <span class="result-source" *ngIf="!result.candidatureId">ğŸ“¤ UploadÃ©</span>

          <!-- CHECK + BOUTON LOCAL (proche) -->
          <div class="select-inline" *ngIf="result.candidatureId">
            <label class="checkline">
              <input
                type="checkbox"
                [checked]="selectedMap[result.candidatureId]"
                (change)="toggleSelect(result, i)" />
              SÃ©lectionner
            </label>

            <!-- appelle la mÃªme action globale, mais placÃ© juste Ã  cÃ´tÃ© -->
            <button
              class="btn btn-xxs btn-success"
              *ngIf="selectedMap[result.candidatureId]"
              (click)="checkSelected()"
              [disabled]="loading"
              title="Ajouter la sÃ©lection Ã  la liste">
              â• Ajouter la sÃ©lection
            </button>
          </div>
        </div>

        <!-- Informations candidat -->
        <div class="candidate-info">
          <div class="info-item" *ngIf="result.cv_extracted?.email || result.candidatEmail">
            <span class="info-icon">ğŸ“§</span>
            <span>{{ result.cv_extracted.email || result.candidatEmail || 'Non disponible' }}</span>
          </div>
          <div class="info-item" *ngIf="result.cv_extracted?.phone">
            <span class="info-icon">ğŸ“</span>
            <span>{{ result.cv_extracted.phone }}</span>
          </div>
          <div class="info-item" *ngIf="result.cv_extracted?.years_experience !== undefined">
            <span class="info-icon">â³</span>
            <span>{{ result?.cv_extracted?.years_experience ?? 'N/A' }} ans d'expÃ©rience</span>
          </div>
          <div class="info-item" *ngIf="result.cv_extracted?.location">
            <span class="info-icon">ğŸ“</span>
            <span>{{ result.cv_extracted.location }}</span>
          </div>
        </div>

        <!-- Message d'erreur -->
        <div *ngIf="result.error" class="error-message">
          <span class="error-icon">âŒ</span>
          <span>Erreur d'analyse: {{ result.error }}</span>
        </div>

        <!-- CompÃ©tences correspondantes -->
        <div class="skills-section" *ngIf="result.cv_extracted?.skills && result.cv_extracted.skills.length > 0">
          <h5>âœ… CompÃ©tences correspondantes</h5>
          <div class="skills-list">
            <span *ngFor="let skill of result.cv_extracted.skills" class="skill-tag matched">{{ skill }}</span>
          </div>
        </div>

        <!-- CompÃ©tences manquantes -->
        <div class="skills-section" *ngIf="result.missing_skills && result.missing_skills.length > 0">
          <h5>âŒ CompÃ©tences manquantes</h5>
          <div class="skills-list">
            <span *ngFor="let skill of result.missing_skills" class="skill-tag missing">{{ skill }}</span>
          </div>
        </div>

        <!-- DÃ©tail des scores -->
        <div class="criteria-scores" *ngIf="result.criteria">
          <h5>ğŸ“ˆ DÃ©tail des scores</h5>

          <div class="score-item" *ngIf="result.criteria.title_match !== undefined">
            <span class="score-label">Titre</span>
            <span class="score-value">{{ result.criteria.title_match * 100 | number:'1.0-0' }}%</span>
            <div class="progress-bar"><div class="progress-fill" [style.width.%]="result.criteria.title_match * 100"></div></div>
          </div>

          <div class="score-item" *ngIf="result.criteria.skills_match !== undefined">
            <span class="score-label">CompÃ©tences</span>
            <span class="score-value">{{ result.criteria.skills_match * 100 | number:'1.0-0' }}%</span>
            <div class="progress-bar"><div class="progress-fill" [style.width.%]="result.criteria.skills_match * 100"></div></div>
          </div>

          <div class="score-item" *ngIf="result.criteria.experience_match !== undefined">
            <span class="score-label">ExpÃ©rience</span>
            <span class="score-value">{{ result.criteria.experience_match * 100 | number:'1.0-0' }}%</span>
            <div class="progress-bar"><div class="progress-fill" [style.width.%]="result.criteria.experience_match * 100"></div></div>
          </div>

          <div class="score-item" *ngIf="result.criteria.location_match !== undefined">
            <span class="score-label">Localisation</span>
            <span class="score-value">{{ result.criteria.location_match * 100 | number:'1.0-0' }}%</span>
            <div class="progress-bar"><div class="progress-fill" [style.width.%]="result.criteria.location_match * 100"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Aucun rÃ©sultat -->
  <div *ngIf="!loading && matchingResults.length === 0 && selectedOffre" class="no-results">
    <div class="no-results-content">
      <span class="no-results-icon">ğŸ”</span>
      <h4>Aucun rÃ©sultat Ã  afficher</h4>
      <p>Veuillez analyser des CVs pour voir les rÃ©sultats de matching.</p>
    </div>
  </div>
</div>
